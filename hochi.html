<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>æ”¾ç½®ãƒãƒˆãƒ« - é€éç”»åƒå¯¾å¿œç‰ˆ</title>
    <style>
        :root {
            --primary-blue: #3498db;
            --dark-bg: #1a1c2c;
            --panel-bg: rgba(44, 62, 80, 0.9);
            --hp-color: #e74c3c;
            --stage-color: #9b59b6;
            --boss-color: #f1c40f;
        }
        body { 
            background-color: var(--dark-bg); 
            color: white; 
            font-family: sans-serif; 
            margin: 0; 
            height: 100vh; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            overflow: hidden; 
            /* èƒŒæ™¯ã«å°‘ã—ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å…¥ã‚Œã¦é€éã‚’æ˜ ãˆã•ã›ã‚‹ */
            background: radial-gradient(circle, #2c3e50 0%, #1a1c2c 100%);
        }
        
        .left-panel { position: absolute; top: 20px; left: 20px; width: 120px; display: flex; flex-direction: column; gap: 10px; }
        .chest-panel { background: var(--panel-bg); padding: 10px; border-radius: 12px; border: 2px solid #f1c40f; text-align: center; }
        .chest-bar-container { width: 100%; height: 6px; background: #34495e; border-radius: 3px; margin-top: 5px; overflow: hidden; }
        .chest-bar-fill { height: 100%; background: #f1c40f; width: 0%; transition: width 0.5s; }
        
        #retry-boss-btn { 
            display: none; width: 100%; padding: 10px; background: #c0392b; color: white; border: 2px solid #fff; 
            border-radius: 8px; cursor: pointer; font-weight: bold; animation: pulse 1s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        .stage-info { position: absolute; top: 20px; text-align: center; width: 300px; }
        .stage-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 5px; }
        .stage-bar-container { width: 100%; height: 12px; background: #34495e; border-radius: 6px; overflow: hidden; }
        .stage-bar-fill { height: 100%; width: 0%; transition: width 0.3s; }

        .top-right-panel { position: absolute; top: 20px; right: 20px; width: 180px; background: var(--panel-bg); padding: 15px; border-radius: 12px; border: 2px solid var(--primary-blue); }
        .status-val { color: #f1c40f; font-weight: bold; }
        .upgrade-btn { width: 100%; padding: 10px; background: #e67e22; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        .upgrade-btn:disabled { background: #7f8c8d; opacity: 0.5; }

        .battle-zone { display: flex; align-items: center; gap: 60px; margin-top: 40px; }
        .unit { text-align: center; width: 150px; position: relative; }

        /* ç”»åƒã®è¨­å®šï¼šæ ç·šã‚’æ¶ˆã—ã€é€éã‚’æ´»ã‹ã™ */
        .player-img, .enemy-img { 
            width: 140px; 
            height: 140px; 
            object-fit: contain; /* ç”»åƒå…¨ä½“ã‚’è¡¨ç¤º */
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.2)); /* è»½ãå…‰ã‚‰ã›ã¦å­˜åœ¨æ„Ÿã‚’å‡ºã™ */
            transition: transform 0.1s, opacity 0.3s; 
        }

        .sprite { font-size: 5rem; line-height: 140px; }
        .attack-left { transform: translateX(40px) rotate(10deg); }
        .attack-right { transform: translateX(-40px) rotate(-10deg); }
        
        .hp-num { font-size: 0.9rem; font-weight: bold; margin-bottom: 5px; display: block; }
        .hp-container { width: 100%; height: 10px; background: #34495e; border-radius: 5px; overflow: hidden; }
        .hp-fill { height: 100%; background: var(--hp-color); width: 100%; transition: width 0.2s; }
        
        .dmg-pop { position: absolute; top: -30px; left: 0; right: 0; color: #fff; font-size: 2rem; font-weight: bold; text-shadow: 2px 2px 0 #000; animation: dmgAnim 0.5s forwards; display: none; z-index: 100; }
        @keyframes dmgAnim { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-50px); } }

        #skill-name { position: absolute; top: -70px; left: 0; right: 0; color: #ff0000; font-size: 2.5rem; font-weight: bold; display: none; text-shadow: 0 0 15px white; z-index: 101; }
    </style>
</head>
<body>

<div class="left-panel">
    <div class="chest-panel">
        <div style="font-size:1.5rem">ğŸ</div>
        <div style="font-size:0.7rem"><span id="chest-percent">0</span>%</div>
        <div class="chest-bar-container"><div id="chestBar" class="chest-bar-fill"></div></div>
    </div>
    <button id="retry-boss-btn" onclick="challengeBoss()">ãƒœã‚¹ã«å†æŒ‘æˆ¦</button>
</div>

<div class="stage-info">
    <div class="stage-title" id="stage-display">STAGE 1-1</div>
    <div class="stage-bar-container"><div id="stageBar" class="stage-bar-fill"></div></div>
    <div class="stage-count" id="stage-count-text">æ•µã®è¨ä¼æ•°: 0 / 5</div>
</div>

<div class="top-right-panel">
    <div style="font-size:0.8rem">Lv: <span id="lv" class="status-val">1</span></div>
    <div style="font-size:0.8rem">ATK: <span id="atk" class="status-val">10</span></div>
    <div style="font-size:0.8rem">EXP: <span id="exp" class="status-val">0</span></div>
    <button id="upgradeBtn" class="upgrade-btn">Lv UP</button>
</div>

<div class="battle-zone">
    <div class="unit">
        <div id="p-dmg" class="dmg-pop"></div>
        <span class="hp-num" id="p-hp-text">100/100</span>
        <div class="hp-container"><div id="p-hp-bar" class="hp-fill"></div></div>
        <img src="yoshikimaru.png" alt="P" class="player-img" id="p-sprite">
        <div style="font-size:0.7rem; margin-top:5px; font-weight:bold;">YOSHIKIMARU</div>
    </div>

    <div style="font-size: 1.5rem; color: #555;">VS</div>

    <div class="unit">
        <div id="skill-name">STF!!</div>
        <div id="e-dmg" class="dmg-pop"></div>
        <span class="hp-num" id="e-hp-text">50/50</span>
        <div class="hp-container"><div id="e-hp-bar" class="hp-fill"></div></div>
        <div id="enemy-body">
            <div id="e-sprite-icon" class="sprite">ğŸ‘¾</div>
            <img id="e-sprite-img" src="maha.png" class="enemy-img" style="display:none;">
        </div>
        <div style="font-size:0.7rem; margin-top:5px; font-weight:bold;" id="e-name">MONSTER</div>
    </div>
</div>

<script>
    const MAX_OFFLINE = 7200;
    const ENEMIES_PER_STAGE = 5;
    const SAVE_KEY = 'idleGame_final_v3';

    let player = JSON.parse(localStorage.getItem(SAVE_KEY)) || {
        lv: 1, exp: 0, atk: 10, hp: 100, maxHp: 100, cost: 10, lastTime: Date.now(),
        world: 1, stage: 1, defeatedInStage: 0, bossUnlocked: true
    };

    let enemy = { hp: 50, maxHp: 50, atk: 5, isDead: false, isBoss: false, skillTimer: 0 };

    function save() { 
        player.lastTime = Date.now(); 
        localStorage.setItem(SAVE_KEY, JSON.stringify(player)); 
    }

    // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ãƒœã‚¿ãƒ³
    document.getElementById('upgradeBtn').onclick = function() {
        if (player.exp >= player.cost) {
            player.exp -= player.cost;
            player.lv++;
            player.atk += 10;
            player.maxHp += 50;
            player.hp = player.maxHp;
            player.cost = Math.floor(player.cost * 1.6);
            updateDisplay();
            save();
        }
    };

    function challengeBoss() {
        player.stage = 10;
        player.defeatedInStage = 0;
        player.bossUnlocked = true;
        updateDisplay();
        respawnEnemy();
    }

    setInterval(() => {
        if (enemy.isDead) return;
        performAttack(true); // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¿ãƒ¼ãƒ³
        if (!enemy.isDead) {
            setTimeout(() => {
                if (enemy.isDead) return;
                performAttack(false); // æ•µã®ã‚¿ãƒ¼ãƒ³
                save();
            }, 500);
        }
    }, 1500);

    function performAttack(isPlayerAttacking) {
        let attacker = isPlayerAttacking ? player : enemy;
        let target = isPlayerAttacking ? enemy : player;
        let spriteId = isPlayerAttacking ? 'p-sprite' : (enemy.isBoss ? 'e-sprite-img' : 'e-sprite-icon');
        let animClass = isPlayerAttacking ? 'attack-left' : 'attack-right';
        let dmgId = isPlayerAttacking ? 'e-dmg' : 'p-dmg';

        const sprite = document.getElementById(spriteId);
        if(sprite) {
            sprite.classList.add(animClass);
            setTimeout(() => sprite.classList.remove(animClass), 100);
        }

        let damage = attacker.atk;
        if (!isPlayerAttacking && enemy.isBoss) {
            enemy.skillTimer++;
            if (enemy.skillTimer >= 2) { 
                damage = 5000;
                document.getElementById('skill-name').style.display = 'block';
                setTimeout(() => document.getElementById('skill-name').style.display = 'none', 800);
                enemy.skillTimer = 0;
            }
        }

        const finalDmg = Math.floor(damage * (0.9 + Math.random() * 0.2));
        target.hp -= finalDmg;

        const dmgEl = document.getElementById(dmgId);
        dmgEl.innerText = finalDmg;
        dmgEl.style.display = 'block';
        setTimeout(() => dmgEl.style.display = 'none', 400);

        if (target.hp <= 0) {
            if (isPlayerAttacking) {
                enemy.isDead = true;
                player.exp += (enemy.isBoss ? player.lv * 100 : player.lv * 2);
                if (enemy.isBoss) {
                    player.world++;
                    player.stage = 1;
                    player.defeatedInStage = 0;
                } else {
                    player.defeatedInStage++;
                    if (player.defeatedInStage >= ENEMIES_PER_STAGE) {
                        player.defeatedInStage = 0;
                        player.stage++;
                    }
                }
                setTimeout(respawnEnemy, 500);
            } else {
                player.hp = player.maxHp;
                enemy.hp = enemy.maxHp;
                if (enemy.isBoss) {
                    player.stage = 9;
                    player.bossUnlocked = false;
                    setTimeout(respawnEnemy, 500);
                }
            }
        }
        updateDisplay();
    }

    function respawnEnemy() {
        enemy.isBoss = (player.stage === 10);
        const difficulty = (player.world - 1) * 10 + player.stage;
        const eIcon = document.getElementById('e-sprite-icon');
        const eImg = document.getElementById('e-sprite-img');
        
        if (enemy.isBoss) {
            enemy.maxHp = 2000 + (player.world * 1500);
            enemy.atk = 50;
            document.getElementById('e-name').innerText = "ãƒãƒãƒ¼ãƒªã‚³ãƒ”ãƒ³";
            eIcon.style.display = "none";
            eImg.style.display = "block";
            enemy.skillTimer = 0;
        } else {
            enemy.maxHp = 40 + (difficulty * 15);
            enemy.atk = 4 + (difficulty * 3);
            document.getElementById('e-name').innerText = "MONSTER";
            eIcon.style.display = "block";
            eImg.style.display = "none";
        }
        enemy.hp = enemy.maxHp;
        enemy.isDead = false;
        document.getElementById('enemy-body').style.opacity = "1";
        updateDisplay();
    }

    function updateDisplay() {
        document.getElementById('stage-display').innerText = `STAGE ${player.world}-${player.stage}`;
        document.getElementById('stage-display').style.color = (player.stage === 10) ? "var(--boss-color)" : "var(--stage-color)";
        document.getElementById('stageBar').style.backgroundColor = (player.stage === 10) ? "var(--boss-color)" : "var(--stage-color)";
        
        const stagePercent = (player.stage === 10) ? 100 : (player.defeatedInStage / ENEMIES_PER_STAGE) * 100;
        document.getElementById('stageBar').style.width = stagePercent + "%";
        document.getElementById('stage-count-text').innerText = (player.stage === 10) ? "BOSS BATTLE!" : `æ•µã®è¨ä¼æ•°: ${player.defeatedInStage} / ${ENEMIES_PER_STAGE}`;
        
        document.getElementById('p-hp-text').innerText = `${Math.max(0, Math.floor(player.hp))}/${player.maxHp}`;
        document.getElementById('e-hp-text').innerText = `${Math.max(0, Math.floor(enemy.hp))}/${enemy.maxHp}`;
        
        document.getElementById('lv').innerText = player.lv;
        document.getElementById('atk').innerText = player.atk;
        document.getElementById('exp').innerText = player.exp;
        
        document.getElementById('p-hp-bar').style.width = (player.hp / player.maxHp * 100) + "%";
        document.getElementById('e-hp-bar').style.width = (Math.max(0, enemy.hp) / enemy.maxHp * 100) + "%";
        
        document.getElementById('upgradeBtn').disabled = player.exp < player.cost;
        document.getElementById('upgradeBtn').innerText = `LvUP (${player.cost})`;
        
        const diff = Math.floor((Date.now() - player.lastTime) / 1000);
        const chestVal = Math.min(Math.floor((diff / MAX_OFFLINE) * 100), 100);
        document.getElementById('chestBar').style.width = chestVal + "%";
        document.getElementById('chest-percent').innerText = chestVal;
        
        document.getElementById('retry-boss-btn').style.display = (!player.bossUnlocked && player.stage === 9) ? 'block' : 'none';
    }

    respawnEnemy();
</script>
</body>
</html>
